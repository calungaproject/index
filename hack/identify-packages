#!/bin/bash
set -euo pipefail

PACKAGES_FILE="$1"
REVISION="$2"
RESULT_FILE="$3"
EMPTY_RESULT_FILE="$4"

echo "[DEBUG] PACKAGES_FILE=${PACKAGES_FILE} REVISION=${REVISION} RESULT_FILE=${RESULT_FILE}" >&2

git remote -v

set +e
OLD_PACKAGES="$(git show "origin/${REVISION}:${PACKAGES_FILE}")"
err="$?"
set -e

# 128 indicates the file does not exist at the provided git reference. This may be the case when
# creating a new index, for example.
if [[ $err -eq 128 ]]; then
    echo "[DEBUG] ${PACKAGES_FILE} doesn't exist at ${REVISION} git reference, using empty file" >&2
    OLD_PACKAGES=""
fi

NEW_PACKAGES="$(comm -13 <(<<<"${OLD_PACKAGES}" sort -u) <(< "${PACKAGES_FILE}" sort -u))"

echo "Packages to build:"
echo "${NEW_PACKAGES}"

NEW_PACKAGES_JSON='[]'
if [[ -n "$NEW_PACKAGES" ]]; then
    # Turn the output into a JSON Array. `sed` is used to avoid a dependency on `jq`.
    NEW_PACKAGES_JSON="$(<<< "${NEW_PACKAGES}" sed -e ':a;N;$!ba;s/\n/", "/g' | sed -e 's/^/\["/' -e 's/$/"\]/')"
fi

echo "${NEW_PACKAGES_JSON}" | tee "${RESULT_FILE}"

if [[ "${NEW_PACKAGES_JSON}" == "[]" ]]; then
    printf 'no-packages' | tee "${EMPTY_RESULT_FILE}"
else
    printf 'has-packages' | tee "${EMPTY_RESULT_FILE}"
fi
echo
